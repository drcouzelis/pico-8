pico-8 cartridge // http://www.pico-8.com
version 27
__lua__
-- icecream castle
-- david couzelis

-- all actors
actor={}

function make_actor(k,x,y)

 a = {
  k=k,    -- sprite num
  x=x,    -- position
  y=y,
  dx=0,   -- velocity
  dy=0,
  frm=0,  -- animation frame
  --frms=1, -- total frames
  --fps=1,  -- frames per second
  --frmt=0, -- time counter
  w=4,    -- dimentions
  h=4
 }
 
 add(actor,a)
 
 return a
end

function solid(x,y)
 -- true if sprite flag is 1
 return fget(mget(x/8,y/8),1)
end 

function solid_area(x,y,w,h)
 -- true if collision in area
 return
  solid(x-w,y-h) or
  solid(x+w,y-h) or
  solid(x-w,y+h) or
  solid(x+w,y+h)
end

function move_actor(a)
 -- add gravity
 a.dy+=0.2
 if a.dy>4 then a.dy=4 end

 -- possible to move left/right?
 if not solid_area(a.x+a.dx,a.y,
   a.w,a.h) then
  a.x+=a.dx
 end

 -- possible to move up/down?
 if not solid_area(a.x,a.y+a.dy,
   a.w,a.h) then
  a.y+=a.dy
 else
  a.dy=0
 end

 -- animate
 --if a.frmt>=30/a.fps then
 -- a.frm+=1
 -- a.frm%=a.frms
 --end
end

function control_player()
 -- walk
 if (btn(0)) then
  pl.x-=1
  pl.l=true
 end
 if (btn(1)) then
  pl.x+=1
  pl.l=false
 end
 -- jump
 if (btnp(4) or btnp(5)) then
  pl.dy=-3
 end
end

function draw_actor(a)
 -- screen position
 local sx=a.x-a.w
 local sy=a.y-a.h
 spr(a.k+a.frm,sx,sy,1,1,a.l,false)
end

function _init()
 -- dark_blue is transparent
 palt(0,false)
 palt(1,true)
 
 -- create the player
 pl=make_actor(1,8*3,8*14)
 pl.frms=2
 pl.l=false -- facing left?
end

function _update()
 -- input
 control_player()
 -- movement
 foreach(actor,move_actor)
end

function _draw()
 cls(0)
 -- draw map
 map()
 -- draw actors
 foreach(actor,draw_actor)
end
__gfx__
00000000044f44f00000000037753b770050000000000000007aa700a00ee00a7777777700000000000000000000000000000000000000000000000000000000
0000000004fffff0044f44f077757b770050000000000000007aa7000aeeeea07777777700000000000000000000000000000000000000000000000000000000
00700700fff0f0ff04fffff0777577770050000006000600007aa7000eeffee07777777700000000000000000000000000000000000000000000000000000000
00077000ffff0ffffff0f0ff555555575555555506000600007aa7000ffffff07777777700000000000000000000000000000000000000000000000000000000
000770000ffffff0ffff0fff337777b50000050006000600007aa700044444407777777700000000000000000000000000000000000000000000000000000000
00700700000666000ffffff07bb777750000050006600660007aa700004444007777777700000000000000000000000000000000000000000000000000000000
000000000066660000666600777777750000050006600660007aa7000a4444a07777777700000000000000000000000000000000000000000000000000000000
000000000044040000440400555755550000000000000000007aa700a004400a7777777700000000000000000000000000000000000000000000000000000000
__gff__
0000000200040400000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
0000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
__map__
0303030303030303030303030303030300000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
0300000000000004060400000600000300000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
0300040400000000060000000600000300000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
0300000400000000060000000600070300000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
0300000000030503030505030303030300000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
0300000003030303030303030303030300000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
0303000000030400000000000403030300000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
0303030000030000000000040403030300000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
0304040000030000000000000000030300000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
0304000000000000000000000000000300000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
0303030303030505030305030000000300000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
0303030303030303030303030000000300000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
0300000000060000040604000300000300000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
0300000000060004040600000000000300000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
0301000000060000000600000000000300000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
0303030303030303030303030303030300000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
__sfx__
000104001b1501b1501b1501b1501b1501b1501b1501b1501b1501b1501b1501b1501b1501b1501b1501b1501b1501b1501b1501b1501b1501b1501b1501b1501b1501b1501b1501b1501b1501b1501b1501b150
