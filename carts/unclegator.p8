pico-8 cartridge // http://www.pico-8.com
version 29
__lua__
-- unclegator
-- by david couzelis

actors={}

function make_actor(k,x,y)
 local a={
  k=k,
  x=x,
  y=y,
  w=4,
  h=4,
  ofx=-2,
  ofy=-2,
  dx=0,
  dy=0,
  asiz=2,
  aspd=10,
  atmr=0,
  aspr=0,
  update=function(a)
   add_physics(a)
   animate(a)
  end,
  draw=function(a)
   spr(a.k+a.aspr,a.x+a.ofx,a.y+a.ofy)
  end
 }
 add(actors,a)
 return a
end

function solid(x,y)
 -- true if sprite flag is 1
 return fget(mget(x/8,y/8),1)
end

function solid_area(x,y,w,h)
 -- true if collision in area
 return
  solid(x,y) or
  solid(x+w,y) or
  solid(x,y+h) or
  solid(x+w,y+h)
end

function point_in(a,x,y)
 return x>=a.x and x<=a.x+a.w and
  y>=a.y and y<=a.y+a.h
end

function actor_collision(a1,a2)
 return
  point_in(a1,a2.x,a2.y) or
  point_in(a1,a2.x+a2.w,a2.y) or
  point_in(a1,a2.x,a2.y+a2.h) or
  point_in(a1,a2.x+a2.w,a2.y+a2.h)
end

function can_move_x(a)

end

function add_physics(a)

 -- possible to move l/r?
 local orig=a.x
 -- try moving
 a.x+=a.dx
 -- find the direction
 local d=1
 if orig>a.x then d=-1 end
 -- if collision, move back
 -- pixel by pixel
 while solid_area(a.x,a.y,a.w,a.h) do
  a.x-=d
  a.x=flr(a.x)
  a.dx=0
 end
 
 -- possible to move u/d?
 orig=a.y
 a.y+=a.dy
 d=1
 if orig>a.y then d=-1 end
 while solid_area(a.x,a.y,a.w,a.h) do
  a.y-=d
  a.y=flr(a.y)
  a.dy=0
 end
end

function animate(a)
 -- asiz=2,
 -- aspd=10,
 -- atmr=0,
 -- aspr=0,
 if a.asiz>1 then
  if a.atmr>=a.aspd then
   a.atmr=0  -- reset timer
   a.aspr+=1 -- show next sprite
   if a.aspr>=a.asiz then
    a.aspr=0
   end
  else
   a.atmr+=1
  end
 end
end

function control_player()
 local spd=0.5
 if btn(0) then pl.dx=-spd end
 if btn(1) then pl.dx=spd end
 if not btn(0) and not btn(1) then pl.dx=0 end
 if btn(2) then pl.dy=-spd end
 if btn(3) then pl.dy=spd end
 if not btn(2) and not btn(3) then pl.dy=0 end

 if btnp(4) and kidn>1 then
  pl.dx=0
  pl.dy=0
  -- prev character
  kidi-=1
  if kidi<1 then kidi=kidn end
  pl=kids[kidi]
 end
 if btnp(5) and kidn>1 then
  pl.dx=0
  pl.dy=0
  -- next character
  kidi+=1
  if kidi>kidn then kidi=1 end
  pl=kids[kidi]
 end
end

function any_eaten()
 for kid in all(kids) do
  if actor_collision(kid,alg) then
   return kid
  end
 end
 return nil
end

alg_spd=0.5
 
function update_alligator()
 
 -- alligator ai

 add_physics(alg)
 --if solid_area(alg
 --local origx=alg.x
 --local origy=alg.y
 

 animate(alg)
end

function _init()
 palt(0,false)
 palt(8,true)
 
 -- kids
 ofs=2
 kids={}
 kidn=5
 kidi=1
 kids[1]=make_actor(1,(8*1)+ofs,(8*1)+ofs)
 kids[2]=make_actor(17,(8*1)+ofs,(8*14)+ofs)
 kids[3]=make_actor(3,(8*14)+ofs,(8*1)+ofs)
 kids[4]=make_actor(19,(8*14)+ofs,(8*14)+ofs)
 kids[5]=make_actor(5,(8*4)+ofs,(8*10)+ofs)
 pl=kids[kidi]
 
 -- alligator
 alg=make_actor(21,8*7,8*8)
 alg.ofx=0
 alg.ofy=0
 alg.w=7
 alg.h=7
 alg.update=update_alligator
 alg.dx=alg_spd
 
 -- ladder
 ldr=make_actor(10,8*8,8*8)
 ldr.ofx=0
 ldr.ofy=0
 ldr.w=7
 ldr.h=7
 ldr.asiz=1
 
 -- arrow
 arr=make_actor(7,pl.x,pl.y-9)
 arr.update=function(a)
  animate(a)
  a.x=pl.x
  a.y=pl.y-8
 end
end

game_win=false
game_over=false

function _update()
 if not game_over and not game_win then
  control_player()
 else
  pl.dx=0
  pl.dy=0
 end
 
 -- check for escaped kids
 if actor_collision(pl,ldr) then
  del(actors,pl)
  del(kids,pl)
  -- next character
  kidn-=1
  if kidn<=0 then
   game_win=true
  else
   kidi+=1
   if kidi>kidn then kidi=1 end
   pl=kids[kidi]
  end
 end
 
 -- check for eaten kids
 local eaten_kid=any_eaten()
 if eaten_kid then game_over=true end
 
 for a in all(actors) do
  a:update()
 end
end

function _draw()
 cls(12)
 map()
 for a in all(actors) do
  a:draw()
 end
 arr:draw()
 --print("kidi "..kidi,0,0,7)
 if game_over then
  printo("game over!",8*6,8*8)
 end
 if game_win then
  printo("you win!!!",8*6,8*8)
 end
end
-->8
function printo(s,x,y)
 print(s,x-1,y,0)
 print(s,x+1,y,0)
 print(s,x,y-1,0)
 print(s,x,y+1,0)
 print(s,x,y,7)
end
__gfx__
00000000888444888888888888888888888888888888888888888888888888888888888888336688888888880000000000000000000000000000000000000000
00000000884545488884448888444488888888888899998888888888888888888888888883bb5668808888080000000000000000000000000000000000000000
00700700884fff488845454884454548884444888999999888999988888888888888888853355568800000080000000000000000000000000000000000000000
000770008ff1f1ff884fff4884f1f1f88445454889fcfc98899999987aaaaaaa8888888855555556808888080000000000000000000000000000000000000000
000770008fffffff8ff1f1ffffffffff84f1f1f88fffff9889fcfc9887aaaaa87aaaaaaa55555555800000080000000000000000000000000000000000000000
0070070088ff0ff88fffffffffff0fffffffffff8fff0f988fffff98887aaa8887aaaaa800555555808888080000000000000000000000000000000000000000
00000000888f0f8888ff0ff88fff0ff8ffff0fff899f0f988fff0f988887a888887aaa8810005501800000080000000000000000000000000000000000000000
00000000811111118111111181111111811111118111111181111111888888888887a88881000018808888080000000000000000000000000000000000000000
00000000844444488888888888444488888888888888888888888888000000000000000000000000000000000000000000000000000000000000000000000000
00000000444444448444444884444448884444888888888888888838000000000000000000000000000000000000000000000000000000000000000000000000
0000000044ffff444444444484ffff48844444488888888888888833000000000000000000000000000000000000000000000000000000000000000000000000
000000004ff0f0f444ffff4484f0f0f884ffff488888888888338337000000000000000000000000000000000000000000000000000000000000000000000000
000000004ffffff44ff0f0f4ffffffff84f0f0f88333888883303378000000000000000000000000000000000000000000000000000000000000000000000000
0000000044ff0f444ffffff4ffff0fffffffffff3330388383333788000000000000000000000000000000000000000000000000000000000000000000000000
0000000044ff0f4444ff0f448fff0ff8ffff0fff3333333333337888000000000000000000000000000000000000000000000000000000000000000000000000
00000000811111118111111181111111811111111111111111111111000000000000000000000000000000000000000000000000000000000000000000000000
__gff__
0001010101010100000208000000000000010101010404000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
0000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
__map__
0909090909090909090909090909090900000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
0900000000000000000000000000000900000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
0900090009000909000900090909000900000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
0900000000000000000900000000000900000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
0900090009000900090909000909000900000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
0900000000000000000009000909000900000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
0900090909000900090000000000000900000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
0900000009000900090909000909090900000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
09000900000000000a0000000000000900000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
0900090909090009090009090909000900000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
0900000000090000090000000900000900000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
0900090900090900090909000900090900000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
0900090000000900000000000900000900000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
0900090009000909000909090909000900000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
0900000000000000000000000000000900000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
0909090909090909090909090909090900000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
